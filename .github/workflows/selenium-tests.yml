name: Run all tests

on:
  workflow_dispatch:
    inputs:
      test-suite:
        description: 'Which test suite to run'
        required: false
        default: 'full'
        type: choice
        options:
        - stability
        - smoke
        - full
  push:
    branches:
      - main
      - v2/login-remote-issue  # Fixed: removed leading slash
      - feature/**
      - v2/**  # Added: catch all v2 branches
  pull_request:
    branches:
      - main
      - test-branch
  schedule:
    - cron: "0 6 * * *"  # 8:00 AM Zurich time during CEST (summer)

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

  # Run CI/CD stability tests first for feature branches
  test-stability:
    if: false  # Temporarily disabled
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "CI/CD Stability Tests"
      test-type: "stability"
    secrets: inherit

  # Run full tests on v2/login-remote-issue for debugging  
  test-v2-branch:
    if: contains(github.ref, 'v2/login-remote-issue')
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "v2-branch-testing"
      test-type: "full"
    secrets: inherit

  test-staging:
    if: false  # Keep disabled for now
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "staging"
      artifact-name: "testing in staging"
      test-type: "smoke"
    secrets: inherit

  test-production:
    # Run full production tests on main branch or manual trigger (exclude v2/login-remote-issue)
    if: (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && !contains(github.ref, 'v2/login-remote-issue')
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "production-testing"
      test-type: ${{ github.event_name == 'workflow_dispatch' && inputs.test-suite || 'full' }}
    secrets: inherit



   
