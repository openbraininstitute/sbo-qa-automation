name: Run all tests

on:
  workflow_dispatch:
    inputs:
      test-suite:
        description: 'Which test suite to run'
        required: false
        default: 'full'
        type: choice
        options:
        - stability
        - smoke
        - full
        - performance
  push:
    branches:
      - main
      - v2/login-remote-issue
      - feature/**
      - fix/** 
  pull_request:
    branches:
      - main
      - test-branch
  schedule:
    - cron: "0 7 * * *"  # Daily at 7:00 AM UTC (8:00 AM CET/9:00 AM CEST Zurich time)
    - cron: "0 2 * * 1"  # Weekly on Monday at 2:00 AM UTC for performance tests

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

  test-on-push-staging:
    # Run smoke tests on any push (except main)
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "staging"
      artifact-name: "push-staging-${{ github.ref_name }}"
      test-type: "smoke"
    secrets: inherit

  test-on-push-production:
    # Run production tests for ai-chat branch or main
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/v2/ai-chat')
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "push-production-${{ github.ref_name }}"
      test-type: "smoke"
    secrets: inherit

  test-on-push-performance:
    # Run performance tests for ai-chat branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/v2/ai-chat'
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "staging"
      artifact-name: "push-performance-${{ github.ref_name }}"
      test-type: "performance"
    secrets: inherit

  test-production:
    # Run full production tests on main branch, PRs, schedule, or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "production-testing"
      test-type: ${{ github.event_name == 'workflow_dispatch' && inputs.test-suite || 'full' }}
    secrets: inherit

  performance-tests:
    # Run performance tests weekly on Monday or when manually triggered with performance option
    if: (github.event.schedule && github.event.schedule == '0 2 * * 1') || (github.event_name == 'workflow_dispatch' && inputs.test-suite == 'performance')
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "staging"
      artifact-name: "performance-testing"
      test-type: "performance"
    secrets: inherit



   
