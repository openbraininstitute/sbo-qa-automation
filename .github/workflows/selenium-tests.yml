name: Run all tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - v2/login-remote-issue  # Fixed: removed leading slash
      - feature/**
      - v2/**  # Added: catch all v2 branches
  pull_request:
    branches:
      - main
      - test-branch
  schedule:
    - cron: "0 6 * * *"  # 8:00 AM Zurich time during CEST (summer)

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

  # Run CI/CD stability tests first for feature branches
  test-stability:
    if: contains(github.ref, 'v2/') || contains(github.ref, 'feature/')
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "CI/CD Stability Tests"
      test-type: "stability"
    secrets: inherit

  test-staging:
    if: false  # Keep disabled for now
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "staging"
      artifact-name: "testing in staging"
      test-type: "smoke"
    secrets: inherit

  test-production:
    # Only run full production tests on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    needs: run-tests
    uses: ./.github/workflows/reusable-workflow.yml
    with:
      env: "production"
      artifact-name: "Testing in Production"
      test-type: "full"
    secrets: inherit



   
